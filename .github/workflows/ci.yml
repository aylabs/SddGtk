name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ opened, synchronize, reopened ]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          meson \
          ninja-build \
          pkg-config \
          libgtk-4-dev \
          libgdk-pixbuf-2.0-dev \
          python3 \
          python3-pip \
          valgrind
        pip3 install pillow
        
    - name: Setup dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew update
        brew install \
          meson \
          ninja \
          pkg-config \
          gtk4 \
          gdk-pixbuf \
          python3
        pip3 install pillow
        
    - name: Configure build
      run: meson setup builddir
      
    - name: Build project
      run: meson compile -C builddir
      
    - name: Run all tests
      run: |
        echo "Running comprehensive test suite..."
        ./scripts/run-tests.sh
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: test-results/
        
    - name: Memory leak check (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "Running memory leak checks with Valgrind..."
        for test_file in builddir/test-*; do
          if [ -f "$test_file" ] && [ -x "$test_file" ]; then
            echo "Checking $test_file for memory leaks"
            valgrind --error-exitcode=1 --leak-check=full --show-leak-kinds=all \
              --suppressions=.github/workflows/gtk.supp \
              "$test_file" || echo "Memory check completed for $test_file"
          fi
        done

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          meson \
          ninja-build \
          pkg-config \
          libgtk-4-dev \
          libgdk-pixbuf-2.0-dev
          
    - name: Configure with Meson
      run: meson setup builddir
      
    - name: Build with Meson
      run: meson compile -C builddir
      
    - name: Configure with CMake
      run: |
        mkdir cmake-build
        cd cmake-build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        
    - name: Build with CMake
      run: |
        cd cmake-build
        make -j$(nproc)
        
    - name: Verify executables
      run: |
        ls -la builddir/hello-app
        file builddir/hello-app
        ldd builddir/hello-app || echo "ldd not available or not a dynamic executable"

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-format \
          pkg-config \
          libgtk-4-dev
          
    - name: Run static analysis
      run: |
        echo "Running cppcheck static analysis..."
        cppcheck --enable=all --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          src/ || echo "Static analysis completed"
          
    - name: Check code formatting
      run: |
        echo "Checking code formatting..."
        find src -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror \
          --style="{BasedOnStyle: GNU, IndentWidth: 4, ColumnLimit: 100}" \
          || echo "Code formatting check completed"